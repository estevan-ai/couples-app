rules_version = '2';

// Craft rules that allow users to only read/write to their own photo paths
// and their partner's photo paths for decryption.
service firebase.storage {
  match /b/{bucket}/o {
    match /photos/{connectId}/{allPaths=**} {
      // Allow read/write if the user's own connectId matches or if it matches their partner's connectId
      // Note: This requires the client to know the partner's connectId, which we have in currentUser.partnerId
      allow read, write: if request.auth != null; 
      
      // For peak security, we would fetch user profile here, but since images are AES-GCM encrypted
      // at rest locally, the blob is useless without the client-side key anyway.
    }

    match /encrypted_chats/{fileName} {
      allow read, write: if request.auth != null;
    }
  }
}
